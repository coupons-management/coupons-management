<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.gopher.system.dao.mysql.StatisticDAO">

    <select id="getCouponValidCount" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(1) FROM CP_COUPON
        <where>
            EXPIRE_AT &gt;= NOW()
            AND CREATE_TIME &lt;= #{endDate}
            <if test="spider !=null ">
                AND SCRAPY =#{spider}
            </if>
        </where>
    </select>

    <select id="getCouponTotalCount" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(1) FROM CP_COUPON
        <where>
            AND CREATE_TIME &lt;= #{endDate}
            <if test="spider !=null ">
                AND SCRAPY =#{spider}
            </if>
        </where>
    </select>

    <select id="getCouponIncrementCount" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(1) FROM CP_COUPON
        <where>
            AND CREATE_TIME &gt;= #{beginDate}
            AND CREATE_TIME &lt;= #{endDate}
            <if test="spider !=null ">
                AND SCRAPY =#{spider}
            </if>
        </where>
    </select>

    <select id="getStoreUpdateCount" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT( DISTINCT STORE_ID)
        FROM CP_COUPON
        <where>
            AND CREATE_TIME &gt;= #{beginDate}
            AND CREATE_TIME &lt;= #{endDate}
            <if test="spider !=null ">
                AND SCRAPY =#{spider}
            </if>
        </where>
    </select>

    <select id="getStoreIncrementCount" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(1) FROM
        CP_STORE store
        <if test="spiderId > 0">
            INNER JOIN
            CP_SCRAPY_STORE C_S_S
            ON
            store.ID = C_S_S.STORE_ID
        </if>
        <where>
            <if test="spiderId > 0">
                AND C_S_S.SCRAPY_ID = #{spiderId}
            </if>
            AND store.CREATE_TIME &gt;= #{beginDate}
            AND store.CREATE_TIME &lt;= #{endDate}
        </where>
    </select>

    <!--  官网下面的统计 查询的表不一样 -->

    <select id="getCouponValidCountInsite" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(1) FROM CP_OUT_SITE_COUPON COSC
        INNER JOIN CP_COUPON CC
        ON COSC.COUPON_ID = CC.ID
        <where>
            CC.EXPIRE_AT &gt;= NOW()
            AND COSC.CREATE_TIME &lt;= #{endDate}
            AND COSC.OUT_SITE_ID =#{siteId}
        </where>
    </select>

    <select id="getCouponTotalCountInsite" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(1) FROM CP_OUT_SITE_COUPON
        <where>
            CREATE_TIME &lt;= #{endDate}
            AND OUT_SITE_ID =#{siteId}
        </where>
    </select>

    <select id="getCouponIncrementCountInsite" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(1) FROM CP_OUT_SITE_COUPON
        <where>
            CREATE_TIME &gt;= #{beginDate}
            AND CREATE_TIME &lt;= #{endDate}
            AND OUT_SITE_ID =#{siteId}
        </where>
    </select>

    <select id="getStoreUpdateCountInsite" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT( DISTINCT STORE_ID)
        FROM CP_OUT_SITE_COUPON
        <where>
            CREATE_TIME &gt;= #{beginDate}
            AND CREATE_TIME &lt;= #{endDate}
            AND OUT_SITE_ID =#{siteId}
        </where>
    </select>

    <select id="getStoreIncrementCountInsite" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(1) FROM
        CP_OUT_SITE_STORE store
        <where>
            OUT_ID =#{siteId}
            AND store.CREATE_TIME &gt;= #{beginDate}
            AND store.CREATE_TIME &lt;= #{endDate}
        </where>
    </select>

    <select id="getValidCouponStoreCount" resultType="java.lang.Integer"
            parameterType="com.gopher.system.model.vo.request.StatisticRequest">
        SELECT COUNT(storeId) FROM
        (
        SELECT
        cs.ID storeId,
        COUNT(cc.ID) total
        FROM
        CP_STORE cs
        LEFT JOIN
        CP_COUPON cc ON cs.ID = cc.STORE_ID

        <if test="spiderId > 0">
            LEFT JOIN
            CP_SCRAPY_STORE css ON cs.ID = css.STORE_ID
        </if>

        <if test="siteId > 0">
            LEFT JOIN
            CP_OUT_SITE_STORE coss ON cs.ID = coss.STORE_ID
        </if>
        WHERE
        cc.EXPIRE_AT > #{endDate}
        <if test="spiderId > 0">
            AND
            css.SCRAPY_ID = #{spiderId}
        </if>
        <if test="siteId > 0">
            AND
            coss.OUT_ID = #{siteId}
        </if>
        GROUP BY
        cs.ID
        ) TEMP
        <where>
            <if test="validCountBegin != null ">
                total &gt;= #{validCountBegin}
            </if>
            <if test="validCountEnd != null">
                AND
                total &lt;= #{validCountEnd}
            </if>
        </where>
    </select>
</mapper>